<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Trang Qu·∫£n Tr·ªã</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <style>
      /* CSS CHO ADMIN TAB */
      .sidebar {
          display: flex; gap: 10px; padding: 20px; background: #fff; border-bottom: 1px solid #ddd;
      }
      .tab-btn {
          padding: 10px 20px; border: none; background: #eee; cursor: pointer; border-radius: 5px; font-weight: bold;
      }
      .tab-btn.active {
          background: #007bff; color: white;
      }
      .section { display: none; padding: 20px; }
      .section.active { display: block; }

      /* Table Styles */
      table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; }
      th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
      th { background: #f8f9fa; }
      
      .role-badge { padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
      .role-admin { background: #e74c3c; color: white; }
      .role-user { background: #2ecc71; color: white; }
  </style>
</head>
<body>
  <div class="header">H·ªÜ TH·ªêNG QU·∫¢N TR·ªä (ADMIN)</div>

  <div class="sidebar">
      <button class="tab-btn active" onclick="switchTab('products')">üì¶ Qu·∫£n l√Ω S·∫£n ph·∫©m</button>
      <button class="tab-btn" onclick="switchTab('users')">üë• Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</button>
      <button class="tab-btn" onclick="logout()" style="margin-left:auto; background:#95a5a6; color:white;">ƒêƒÉng xu·∫•t</button>
  </div>

  <div id="tab-products" class="section active">
      <div style="text-align:right; margin-bottom:10px;">
          <button onclick="openProductModal()" style="width:auto; background:#007bff;">+ Th√™m s·∫£n ph·∫©m</button>
      </div>
      <div id="product-table">ƒêang t·∫£i...</div>
  </div>

  <div id="tab-users" class="section">
      <div style="text-align:right; margin-bottom:10px;">
          <button onclick="openUserModal()" style="width:auto; background:#28a745;">+ Th√™m User m·ªõi</button>
      </div>
      <div id="user-table">ƒêang t·∫£i...</div>
  </div>

  <div id="modal-product" class="modal" style="display:none;">
    <div class="modal-content">
      <h3 id="p-modal-title">S·∫£n ph·∫©m</h3>
      <input type="hidden" id="p-id" />
      <label>T√™n SP:</label><input type="text" id="p-name" />
      <label>Gi√°:</label><input type="number" id="p-price" />
      <label>Kho:</label><input type="number" id="p-stock" />
      <label>M√¥ t·∫£:</label><input type="text" id="p-desc" />
      <label>Link ·∫£nh:</label><input type="text" id="p-img" />
      <div style="text-align:right; margin-top:10px;">
          <button onclick="saveProduct()">L∆∞u</button>
          <button onclick="closeModal('modal-product')" style="background:#95a5a6;">H·ªßy</button>
      </div>
    </div>
  </div>

  <div id="modal-user" class="modal" style="display:none;">
    <div class="modal-content">
      <h3 id="u-modal-title">Th√¥ng tin User</h3>
      <input type="hidden" id="u-id" />
      
      <label>T√™n ƒëƒÉng nh·∫≠p:</label>
      <input type="text" id="u-username" placeholder="Kh√¥ng th·ªÉ s·ª≠a khi c·∫≠p nh·∫≠t" />
      
      <label>M·∫≠t kh·∫©u:</label>
      <input type="password" id="u-password" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi pass" />

      <label>H·ªç t√™n:</label><input type="text" id="u-fullname" />
      <label>Email:</label><input type="text" id="u-email" />
      <label>SƒêT:</label><input type="text" id="u-phone" />
      <label>ƒê·ªãa ch·ªâ:</label><input type="text" id="u-address" />
      
      <label>Quy·ªÅn h·∫°n:</label>
      <select id="u-role" style="width:100%; padding:10px; margin-bottom:10px;">
          <option value="User">User (Kh√°ch h√†ng)</option>
          <option value="Admin">Admin (Qu·∫£n tr·ªã)</option>
      </select>

      <div style="text-align:right; margin-top:10px;">
          <button onclick="saveUser()">L∆∞u User</button>
          <button onclick="closeModal('modal-user')" style="background:#95a5a6;">H·ªßy</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="script.js"></script>
  <script>
    // Ki·ªÉm tra quy·ªÅn
    if (!localStorage.getItem('token') || (localStorage.getItem('role') || '').toLowerCase() !== 'admin') {
        location.href = 'login.html';
    }

    // --- CHUY·ªÇN TAB ---
    function switchTab(tab) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(`tab-${tab}`).classList.add('active');
        // Highlight button (t√¨m n√∫t ch·ª©a onclick t∆∞∆°ng ·ª©ng - c√°ch ƒë∆°n gi·∫£n)
        event.target.classList.add('active');

        if (tab === 'products') loadProducts();
        if (tab === 'users') loadUsers();
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // ================= QU·∫¢N L√ù S·∫¢N PH·∫®M =================
    async function loadProducts() {
        try {
            const res = await fetch(`${API_URL}/products`);
            const data = await res.json();
            const html = data.map(p => `
                <tr>
                    <td>${p.id}</td>
                    <td><img src="${p.imageUrl || 'https://placehold.co/40'}" style="width:40px;height:40px;object-fit:cover;"></td>
                    <td>${p.name}</td>
                    <td>${p.price.toLocaleString()}ƒë</td>
                    <td>${p.stockQuantity}</td>
                    <td>
                        <button onclick="editProduct(${p.id}, '${p.name}', ${p.price}, ${p.stockQuantity}, '${p.description}', '${p.imageUrl}')">S·ª≠a</button>
                        <button onclick="deleteItem('products', ${p.id})" style="background:#e74c3c;">X√≥a</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('product-table').innerHTML = `<table><tr><th>ID</th><th>·∫¢nh</th><th>T√™n</th><th>Gi√°</th><th>Kho</th><th>H√†nh ƒë·ªông</th></tr>${html}</table>`;
        } catch(e) { console.error(e); }
    }

    function openProductModal() {
        document.getElementById('p-id').value = '';
        document.getElementById('p-name').value = '';
        document.getElementById('p-price').value = '';
        document.getElementById('p-stock').value = '';
        document.getElementById('p-desc').value = '';
        document.getElementById('p-img').value = '';
        document.getElementById('modal-product').style.display = 'block';
    }

    function editProduct(id, name, price, stock, desc, img) {
        document.getElementById('p-id').value = id;
        document.getElementById('p-name').value = name;
        document.getElementById('p-price').value = price;
        document.getElementById('p-stock').value = stock;
        document.getElementById('p-desc').value = desc;
        document.getElementById('p-img').value = img === 'undefined' ? '' : img;
        document.getElementById('modal-product').style.display = 'block';
    }

    async function saveProduct() {
        const id = document.getElementById('p-id').value;
        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_URL}/products/${id}` : `${API_URL}/products`;
        
        const body = {
            name: document.getElementById('p-name').value,
            price: parseFloat(document.getElementById('p-price').value),
            stockQuantity: parseInt(document.getElementById('p-stock').value),
            description: document.getElementById('p-desc').value,
            imageUrl: document.getElementById('p-img').value
        };

        await sendRequest(url, method, body, () => {
            closeModal('modal-product');
            loadProducts();
        });
    }

    // ================= QU·∫¢N L√ù USER =================
    async function loadUsers() {
        try {
            const res = await fetch(`${API_URL}/users`, {
                headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
            });
            const data = await res.json();
            const html = data.map(u => `
                <tr>
                    <td>${u.id}</td>
                    <td><b>${u.username}</b></td>
                    <td>${u.fullName || ''}</td>
                    <td>${u.email || ''}</td>
                    <td><span class="role-badge ${u.role === 'Admin' ? 'role-admin' : 'role-user'}">${u.role}</span></td>
                    <td>
                        <button onclick="editUser(${u.id}, '${u.username}', '${u.fullName}', '${u.email}', '${u.phone}', '${u.address}', '${u.role}')">S·ª≠a</button>
                        <button onclick="deleteItem('users', ${u.id})" style="background:#e74c3c;">X√≥a</button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('user-table').innerHTML = `<table><tr><th>ID</th><th>User</th><th>T√™n</th><th>Email</th><th>Quy·ªÅn</th><th>H√†nh ƒë·ªông</th></tr>${html}</table>`;
        } catch(e) { console.error(e); }
    }

    function openUserModal() {
        document.getElementById('u-id').value = '';
        document.getElementById('u-username').value = '';
        document.getElementById('u-username').disabled = false; // Cho nh·∫≠p khi t·∫°o m·ªõi
        document.getElementById('u-password').value = '';
        document.getElementById('u-fullname').value = '';
        document.getElementById('u-email').value = '';
        document.getElementById('u-phone').value = '';
        document.getElementById('u-address').value = '';
        document.getElementById('u-role').value = 'User';
        document.getElementById('modal-user').style.display = 'block';
    }

    function editUser(id, user, name, email, phone, addr, role) {
        document.getElementById('u-id').value = id;
        document.getElementById('u-username').value = user;
        document.getElementById('u-username').disabled = true; // Kh√¥ng s·ª≠a username c≈©
        document.getElementById('u-password').value = ''; // Reset pass
        document.getElementById('u-fullname').value = name === 'null' ? '' : name;
        document.getElementById('u-email').value = email === 'null' ? '' : email;
        document.getElementById('u-phone').value = phone === 'null' ? '' : phone;
        document.getElementById('u-address').value = addr === 'null' ? '' : addr;
        document.getElementById('u-role').value = role;
        document.getElementById('modal-user').style.display = 'block';
    }

    async function saveUser() {
        const id = document.getElementById('u-id').value;
        const isEdit = !!id;
        const url = isEdit ? `${API_URL}/users/${id}` : `${API_URL}/users`;
        const method = isEdit ? 'PUT' : 'POST';

        const body = {
            username: document.getElementById('u-username').value,
            password: document.getElementById('u-password').value,
            fullName: document.getElementById('u-fullname').value,
            email: document.getElementById('u-email').value,
            phone: document.getElementById('u-phone').value,
            address: document.getElementById('u-address').value,
            role: document.getElementById('u-role').value
        };

        // Validate c∆° b·∫£n
        if (!isEdit && (!body.username || !body.password)) {
            return toast('Vui l√≤ng nh·∫≠p Username v√† Password!', 'error');
        }

        await sendRequest(url, method, body, () => {
            closeModal('modal-user');
            loadUsers();
        });
    }

    // ================= H√ÄM CHUNG =================
    async function deleteItem(type, id) {
        if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a?')) return;
        const url = `${API_URL}/${type}/${id}`;
        await sendRequest(url, 'DELETE', null, () => {
            if (type === 'products') loadProducts();
            else loadUsers();
        });
    }

    async function sendRequest(url, method, body, onSuccess) {
        try {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            };
            if (body) options.body = JSON.stringify(body);

            const res = await fetch(url, options);
            const data = await res.json();

            if (res.ok) {
                toast('Th√†nh c√¥ng!');
                if (onSuccess) onSuccess();
            } else {
                toast(data.message || 'C√≥ l·ªói x·∫£y ra', 'error');
            }
        } catch (err) {
            console.error(err);
            toast('L·ªói k·∫øt n·ªëi server', 'error');
        }
    }

    // M·∫∑c ƒë·ªãnh load tab s·∫£n ph·∫©m
    loadProducts();
  </script>
</body>
</html>