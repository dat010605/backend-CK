<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gi·ªè h√†ng - Mini Order</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <style>
    /* CSS RI√äNG CHO CART COMPACT */
    body { background-color: #f8f9fa; }
    
    /* B·ªë c·ª•c ch√≠nh: Flexbox 2 c·ªôt */
    .cart-wrapper {
        display: flex;
        gap: 20px;
        max-width: 1200px;
        margin: 80px auto 20px; /* C√°ch top 80px tr√°nh menu */
        padding: 0 20px;
        align-items: flex-start;
    }

    /* C·ªòT TR√ÅI: Danh s√°ch s·∫£n ph·∫©m */
    .cart-list {
        flex: 2; /* Chi·∫øm 2/3 chi·ªÅu r·ªông */
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        padding: 20px;
    }

    /* T·ª´ng d√≤ng s·∫£n ph·∫©m */
    .cart-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px 0;
        border-bottom: 1px solid #eee;
    }
    .cart-item:last-child { border-bottom: none; }

    .item-info { display: flex; align-items: center; gap: 15px; }
    .item-img {
        width: 60px; height: 60px;
        background: #f1f1f1; border-radius: 6px;
        object-fit: cover;
    }
    .item-name { font-weight: bold; font-size: 15px; color: #333; }
    .item-price { color: #888; font-size: 13px; }

    /* Input s·ªë l∆∞·ª£ng nh·ªè g·ªçn */
    .qty-input {
        width: 50px; padding: 5px; text-align: center;
        border: 1px solid #ddd; border-radius: 4px;
        font-weight: bold;
    }

    /* C·ªòT PH·∫¢I: T·ªïng ti·ªÅn (Sticky) */
    .cart-summary {
        flex: 1; /* Chi·∫øm 1/3 chi·ªÅu r·ªông */
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        padding: 20px;
        position: sticky;
        top: 90px; /* Tr∆∞·ª£t theo khi cu·ªôn */
    }

    .summary-row {
        display: flex; justify-content: space-between;
        margin-bottom: 15px; font-size: 15px;
    }
    .total-price {
        font-size: 22px; font-weight: bold; color: #e74c3c;
    }
    
    .btn-checkout {
        width: 100%;
        padding: 12px;
        background: #27ae60;
        color: white;
        font-weight: bold;
        border: none; border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
    }
    .btn-checkout:hover { background: #219150; }

    /* Responsive cho mobile */
    @media (max-width: 768px) {
        .cart-wrapper { flex-direction: column; }
        .cart-summary { width: 100%; position: static; }
    }

    /* Gi·ªØ nguy√™n CSS Modal c≈© nh∆∞ng tinh ch·ªânh ch√∫t */
    .modal {
        display: none; position: fixed; z-index: 2000; 
        left: 0; top: 0; width: 100%; height: 100%; 
        background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
        background-color: #fff; margin: 10% auto; padding: 25px;
        border-radius: 8px; width: 90%; max-width: 450px;
    }
    .payment-option { padding: 8px; margin-bottom: 5px; }
  </style>
</head>
<body>

  <nav class="navbar">
    <div class="nav-brand" onclick="location.href='products.html'">üõí Mini Order</div>
    <div class="nav-links">
        <a href="products.html">S·∫£n ph·∫©m</a>
        <a href="cart.html" class="active">Gi·ªè h√†ng</a>
        <div class="user-menu">
            <button onclick="logout()" class="btn-logout">ƒêƒÉng xu·∫•t</button>
        </div>
    </div>
  </nav>

  <div class="cart-wrapper">
      
      <div class="cart-list" id="cart-container">
          <h3 style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
              S·∫£n ph·∫©m trong gi·ªè (<span id="item-count">0</span>)
          </h3>
          <div id="cart-items">
              </div>
      </div>

      <div class="cart-summary">
          <h3 style="margin-bottom:15px;">Thanh to√°n</h3>
          
          <div class="summary-row">
              <span style="color:#666;">T·∫°m t√≠nh:</span>
              <span id="sub-total">0ƒë</span>
          </div>
          <div class="summary-row" style="border-bottom:1px solid #eee; padding-bottom:15px;">
              <span style="color:#666;">Gi·∫£m gi√°:</span>
              <span>0ƒë</span>
          </div>
          
          <div class="summary-row" style="align-items:center;">
              <strong>T·ªïng c·ªông:</strong>
              <span class="total-price" id="final-total">0ƒë</span>
          </div>

          <button class="btn-checkout" onclick="openPaymentModal()">MUA H√ÄNG NGAY</button>
          
          <div style="margin-top:15px; text-align:center;">
            <a href="products.html" style="color:#007bff; text-decoration:none; font-size:14px;">
                ‚Üê Ti·∫øp t·ª•c mua s·∫Øm
            </a>
          </div>
      </div>
  </div>

  <div id="payment-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closePaymentModal()" style="float:right; cursor:pointer; font-size:24px;">&times;</span>
        <h3 style="text-align:center; color:#007bff; margin-bottom:15px;">X√°c nh·∫≠n ƒë·∫∑t h√†ng</h3>
        
        <div class="payment-group">
            <label style="font-weight:bold; font-size:14px;">ƒê·ªãa ch·ªâ nh·∫≠n:</label>
            <textarea id="ship-address" rows="2" style="width:100%; margin-bottom:10px; padding:8px; border:1px solid #ddd; border-radius:4px;" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, ph∆∞·ªùng/x√£..."></textarea>
        </div>

        <div class="payment-group">
            <label style="font-weight:bold; font-size:14px;">S·ªë ƒëi·ªán tho·∫°i:</label>
            <input type="text" id="ship-phone" style="width:100%; margin-bottom:10px; padding:8px; border:1px solid #ddd; border-radius:4px;" placeholder="09xx..." />
        </div>

        <div class="payment-group">
            <label style="font-weight:bold; font-size:14px;">Thanh to√°n:</label>
            <div style="display:flex; gap:5px;">
                <button class="payment-option active" onclick="selectMethod(this, 'COD')" style="flex:1; border:1px solid #007bff; background:#e3f2fd; border-radius:4px; cursor:pointer;">Ti·ªÅn m·∫∑t</button>
                <button class="payment-option" onclick="selectMethod(this, 'BANK')" style="flex:1; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer;">CK</button>
            </div>
        </div>

        <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:18px;">
            <span>T·ªïng ti·ªÅn:</span>
            <span id="modal-total" style="color:#e74c3c;">0ƒë</span>
        </div>

        <button onclick="submitOrder()" style="width:100%; padding:12px; background:#27ae60; color:white; border:none; border-radius:6px; margin-top:15px; cursor:pointer; font-weight:bold;">X√ÅC NH·∫¨N</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="script.js"></script>
  <script>
    if (!checkAuth()) { /* T·ª± ƒë·ªông redirect */ }

    // Render gi·ªè h√†ng
    function loadCart() {
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const container = document.getElementById('cart-items');
      
      // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng tr√™n ti√™u ƒë·ªÅ
      document.getElementById('item-count').textContent = cart.reduce((s,i)=>s+i.quantity,0);

      if (cart.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:30px; color:#999;">Gi·ªè h√†ng tr·ªëng</p>';
        updateSummary(0);
        document.querySelector('.btn-checkout').disabled = true;
        document.querySelector('.btn-checkout').style.background = '#ccc';
        return;
      }

      document.querySelector('.btn-checkout').disabled = false;
      document.querySelector('.btn-checkout').style.background = '#27ae60';

      const html = cart.map(item => `
        <div class="cart-item">
            <div class="item-info">
                 <div style="width:60px; height:60px; background:#eee; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:20px;">üì¶</div>
                <div>
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">${item.price.toLocaleString()}ƒë</div>
                </div>
            </div>
            
            <div style="display:flex; align-items:center; gap:15px;">
                <input type="number" class="qty-input" min="1" value="${item.quantity}" 
                    onchange="updateQuantity(${item.id}, this.value)">
                
                <div style="text-align:right;">
                    <div style="font-weight:bold; color:#333;">${(item.price * item.quantity).toLocaleString()}ƒë</div>
                    <button onclick="removeFromCart(${item.id})" style="background:none; border:none; color:#e74c3c; font-size:12px; cursor:pointer; text-decoration:underline; padding:0;">X√≥a</button>
                </div>
            </div>
        </div>
      `).join('');

      container.innerHTML = html;
      
      // T√≠nh t·ªïng
      const total = cart.reduce((s, i) => s + i.price * i.quantity, 0);
      updateSummary(total);
    }

    function updateSummary(total) {
        const str = total.toLocaleString() + 'ƒë';
        document.getElementById('sub-total').textContent = str;
        document.getElementById('final-total').textContent = str;
        document.getElementById('modal-total').textContent = str;
    }

    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
    function updateQuantity(id, newQty) {
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const item = cart.find(x => x.id === id);
        if (item) {
            item.quantity = parseInt(newQty);
            if(item.quantity < 1) item.quantity = 1;
            localStorage.setItem('cart', JSON.stringify(cart));
            loadCart(); // Render l·∫°i
        }
    }

    // Modal Logic
    function openPaymentModal() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        if (cart.length === 0) return toast('Gi·ªè h√†ng tr·ªëng!', 'error');
        document.getElementById('payment-modal').style.display = 'block';
    }
    function closePaymentModal() {
        document.getElementById('payment-modal').style.display = 'none';
    }
    
    // Ch·ªçn ph∆∞∆°ng th·ª©c (UI)
    function selectMethod(el, method) {
        document.querySelectorAll('.payment-option').forEach(d => {
            d.style.background = '#fff'; d.style.borderColor = '#ddd';
        });
        el.style.background = '#e3f2fd'; el.style.borderColor = '#007bff';
    }

    // G·ª≠i ƒë∆°n h√†ng
    async function submitOrder() {
        const address = document.getElementById('ship-address').value.trim();
        const phone = document.getElementById('ship-phone').value.trim();

        if (!address || !phone) return toast('Nh·∫≠p thi·∫øu ƒë·ªãa ch·ªâ/SƒêT', 'error');

        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const orderDetails = cart.map(x => ({ productId: x.id, quantity: x.quantity }));

        try {
            const btn = document.querySelector('#payment-modal button[onclick="submitOrder()"]');
            btn.textContent = "ƒêang x·ª≠ l√Ω..."; btn.disabled = true;

            const res = await fetch(`${API_URL}/orders`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({ items: orderDetails })
            });
            
            if (res.ok) {
                const data = await res.json();
                localStorage.removeItem('cart');
                toast('ƒê·∫∑t h√†ng th√†nh c√¥ng!');
                setTimeout(() => location.href = `sucess.html?id=${data.id}`, 1000);
            } else {
                const data = await res.json();
                toast(data.message || 'L·ªói ƒë·∫∑t h√†ng', 'error');
                btn.textContent = "X√ÅC NH·∫¨N"; btn.disabled = false;
            }
        } catch {
            toast('L·ªói k·∫øt n·ªëi', 'error');
        }
    }

    // Kh·ªüi ch·∫°y
    loadCart();
  </script>
</body>
</html>